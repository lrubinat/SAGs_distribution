---
title: "SAGs_distribution"
date: "6.12.2016"
output:  
  html_document:
    theme: united
    toc: yes
  pdf_document:
    highlight: zenburn
    toc: yes
---

<!--- INITIALIZATION
```{r, echo=FALSE}
#error hook to kill knitr in case of errors
library(knitr)
knit_hooks$set(error = function(x, options) stop(x))
opts_chunk$set(cache=TRUE, autodep=TRUE)
```
--->

```{r libraries, echo=F, message=F}
library(vegan)
library(data.table)
library(analogue)
library(tidyr)
```


1) Occurrence table
2) Correlation matrix
3) PCA - eigenvalues examination

# 1) SURFACE samples 

```{r samples_selection_SRF, cache.lazy=F, echo=F}
setwd("~/Documents/2Q16/analyses/exploratory_figures/SAGs_distribution/")

#global occurrence of swarms in Tara Oceans, BioMarKs and Tara Arctic.
swarms_tb<-fread("/home/lrubinat/Documents/2Q16/data/TARA_V9/globaldataset.otu.v20160830")
head(swarms_tb)

#selection of Tara samples.
tara_sples<-fread("sple.csv")
tara_sples<-tara_sples[fraction%in%c("0.8-5")&depth%in%c("SUR")&template=="DNA"]

#extract swarms that occur in the selected samples
swarms_abund<-swarms_tb[,.SD,.SDcols=c("md5sum",tara_sples$sample)]
swarms_abund<-melt(swarms_abund,id.vars="md5sum")
swarms_abund<-swarms_abund[value>0]
#write.table(swarms_abund, "data_abund_table.txt", sep="\t",row.names=T)

setkey(swarms_abund,variable)
setkey(tara_sples,sample)
swarms_abund<-tara_sples[swarms_abund]

#write.table(swarms_abund, "data_abund_table.txt", sep="\t", row.names=T)
#data_abund<-fread("data_abund_table.txt")

#otutb of all swarms occurring in one of the samples 
swarms_otutb <- dcast(swarms_abund, md5sum ~ sample)
swarms_otutb[is.na(swarms_otutb)] <- 0
swarms_otutb[1:5,1:5]
dim(swarms_otutb)

#otutables of SAGs in surface samples
sags_vs_swarms_SRF<-fread("sags_vs_swarms_piconano_SRF.txt")
colnames(sags_vs_swarms_SRF)<-c("no.","id_classif","md5sum","ident.%","SAG_lth","swm_lth","coverage","abund","rank","taxogroup","algae_group","status")
sags_vs_swarms_SRF[1:5,]
dim(sags_vs_swarms_SRF)

sags_otutb_SRF<-merge(swarms_otutb,sags_vs_swarms_SRF, by="md5sum")
sags_otutb_SRF[1:5,]
dim(sags_otutb_SRF)

test<-sags_otutb_SRF
row.names(test)<-paste(row.names(test),test$id_classif, sep = "_")
test[1:5,1:5]
row.names(test)

###################

test_only_occur<-test[,2:104]
test_only_occur[1:5,]
row.names(test_only_occur)<-row.names(test)
row.names(test_only_occur)

test_hell <- tran(test_only_occur, "hellinger")
dim(test_hell)
test_hell[1:5,1:5]

test.pca<-rda(test_hell,scale=TRUE)

test.pca
summary(test.pca)
head(summary(test.pca, scaling=1))

########
# comparison of eigenvalues through kaiser-guttam criterion

test_eig <- test.pca$CA$eig
test_eig[test_eig > mean(test_eig)]

#par(mfrow=c(1,1)) <-- reset par
barplot(test_eig, main = "Eigenvalues", col="bisque", las=T)
abline(h=mean(test_eig), col="red") #average eigenvalue
#legend("topright", "Average eigenvalue", lwd=1, col=2, bty="n")

biplot.rda(test.pca, scaling=2, main="PCA-scaling 1")
#biplot.rda(test.pca, main="PCA - sc2")

cleanplot.pca(test.pca, point =TRUE)
cleanplot.pca(test.pca)
cleanplot.pca(test.pca, ahead=0)

cleanplot_exp(test.pca, point =TRUE)
cleanplot_exp(test.pca)
cleanplot_exp(test.pca, ahead=0)
############################

```



```{r samples_selection_DCM, echo=FALSE}
#otutables of SAGs in DCM samples
sags_vs_swarms_DCM<-fread("sags_vs_swarms_piconano_DCM.txt")
colnames(sags_vs_swarms_DCM)<-c("no.","id_classif","md5sum","ident.%","SAG_lth","swm_lth","coverage","abund","rank","taxogroup","algae_group","status")
dim(sags_vs_swarms_DCM)

sags_otutb_DCM<-merge(swarms_otutb,sags_vs_swarms_DCM, by="md5sum")
dim(sags_otutb_DCM)

row.names(sags_otutb_DCM)<-sags_otutb_DCM[,1]
sags_otutb_DCM<-sags_otutb_DCM[,-1]


dim(sags_otutb_DCM)
```


```{r pca_srf, echo=FALSE}
sags_SRF_hell <- tran(sags_vs_swarms_SRF, "hellinger")

```


```{r beta_div1, echo=FALSE}
#?vegdist
#tb18_tax_occur_ss8522_no_cero.bray<-vegdist(tb18_tax_occur_ss8522_no_cero, method="bray")
#boxplot(tb18_tax_occur_ss8522_no_cero.bray, main="Bray-Curtis dissimilarity matrix")


#NMDS
#tb18_tax_occur_ss8522_no_cero.nmds<-monoMDS(tb18_tax_occur_ss8522_no_cero.bray)
#tb18_tax_occur_ss8522_no_cero.nmds
#plot(tb18_tax_occur_ss8522_no_cero.nmds, main="monoMDs method")
```


