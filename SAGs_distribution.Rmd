---
title: "SAGs_distribution"
date: "6.12.2016"
output:  
  html_document:
    theme: united
    toc: yes
  pdf_document:
    highlight: zenburn
    toc: yes
---

<!--- INITIALIZATION
```{r, echo=FALSE}
#error hook to kill knitr in case of errors
library(knitr)
knit_hooks$set(error = function(x, options) stop(x))
opts_chunk$set(cache=TRUE, autodep=TRUE)
```
--->


# 1) Abundance overview

```{r libraries, echo=F, message=F}
library(vegan)
library(data.table)
```


1) Occurrence table
2) Correlation matrix
3) PCA - eigenvalues examination


```{r samples_selection, cache.lazy=F, echo=F}
#global occurrence of swarms in Tara Oceans, BioMarKs and Tara Arctic.
swarms_tb<-fread("/home/lrubinat/Documents/2Q16/data/TARA_V9/globaldataset.otu.v20160830")
head(swarms_tb)

#selection of Tara samples.
tara_sples<-fread("sple.csv")
tara_sples<-tara_sples[fraction%in%c("0.8-5")&depth%in%c("SUR","DCM")&template=="DNA"]

#extract swarms that occur in the selected samples
swarms_abund<-swarms_tb[,.SD,.SDcols=c("md5sum",tara_sples$sample)]
swarms_abund<-melt(swarms_abund,id.vars="md5sum")
swarms_abund<-swarms_abund[value>0]
write.table(swarms_abund, "data_abund_table.txt", sep="\t",row.names=T)

setkey(swarms_abund,variable)
setkey(tara_sples,sample)
swarms_abund<-tara_sples[swarms_abund]

write.table(swarms_abund, "data_abund_table.txt", sep="\t", row.names=T)
#data_abund<-fread("data_abund_table.txt")

swarms_otutb <- dcast(swarms_abund, md5sum ~ sample)
swarms_otutb[is.na(swarms_otutb)] <- 0
swarms_otutb<-swarms_otutb[,-(which(colSums(swarms_otutb)==0))]
head(swarms_otutb)
dim(swarms_otutb)

#temp<-data[taxogroup=="Prasinophyceae Clade 7"]
#rbind.fill.matrix(lapply(strsplit(temp$lineage,"\\|"),function(X) t(as.matrix(X))))
```




All swarms

```{r fig_all, echo=F}
temp<-data_abund[,sum(value),by=md5sum]
setkey(temp,md5sum)
setkey(output,md5sum)
temp<-output[temp,allow.cartesian=T]
temp<-temp[order(V1,decreasing = T)]
temp[,rank:=1:nrow(temp)]
temp<-temp[V1>10]
temp[,SAG:=sapply(identity,function(X) ifelse(is.na(X),"no","yes"))]
temp<-join(temp, SAGs_classification)
temp[1:12,]

swarms_groups <- list(
  "no"="no SAG aligned",
  "yes"="SAG(s) aligned"
)

swarms_labeller <- function(variable,value){
  return(swarms_groups[value])
}













```{r beta_div1, echo=FALSE}
#?vegdist
tb18_tax_occur_ss8522_no_cero.bray<-vegdist(tb18_tax_occur_ss8522_no_cero, method="bray")
boxplot(tb18_tax_occur_ss8522_no_cero.bray, main="Bray-Curtis dissimilarity matrix")


#NMDS
tb18_tax_occur_ss8522_no_cero.nmds<-monoMDS(tb18_tax_occur_ss8522_no_cero.bray)
tb18_tax_occur_ss8522_no_cero.nmds
plot(tb18_tax_occur_ss8522_no_cero.nmds, main="monoMDs method")
```


